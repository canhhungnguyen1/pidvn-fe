<nz-tag [nzColor]="'purple'">RequestNo: {{ requestNo }}</nz-tag>

<dx-data-grid
  #lotGrid
  keyExpr="id"
  [dataSource]="lots"
  [showColumnLines]="true"
  [showRowLines]="true"
  [showBorders]="true"
  [allowColumnResizing]="true"
  [columnAutoWidth]="true"
  [rowAlternationEnabled]="true"
  (onExporting)="onExportClient($event)"
  [grouping]="{ autoExpandAll: expandAll }"
  style="margin-top: 10px"
>
  <dxo-grouping [autoExpandAll]="expandAll"></dxo-grouping>
  <dxo-column-chooser
    #columnChooser
    [enabled]="true"
    [mode]="'select'"
    [title]="'Cột hiển thị'"
  >
  </dxo-column-chooser>

  <dxo-search-panel [visible]="true"></dxo-search-panel>
  <dxo-load-panel [enabled]="false"></dxo-load-panel>
  <dxo-export [enabled]="true"></dxo-export>

  <dxo-toolbar>
    <dxi-item location="before">
      <button nz-button nzType="primary" (click)="openReceiveModal()">
        <span nz-icon nzType="qrcode"></span>
        Nhận NVL
      </button>
    </dxi-item>
    <dxi-item location="before">
      <button nz-button nzType="default" (click)="toggleExpandAll()">
        <span nz-icon [nzType]="expandAll ? 'minus' : 'plus'"></span>
        {{ expandAll ? "Thu gọn" : "Mở rộng" }}
      </button>
    </dxi-item>

    <dxi-item location="after" name="searchPanel"></dxi-item>
    <dxi-item location="after">
      <div *dxTemplate>
        <dx-button icon="refresh" (onClick)="resetFiltersAndSorting()">
        </dx-button>
      </div>
    </dxi-item>
    <dxi-item name="exportButton" location="after" />
    <dxi-item name="columnChooserButton" location="after"></dxi-item>
    <dxi-item location="after">
      <div *dxTemplate>
        <dx-button
          icon="info"
          type="danger"
          stylingMode="outlined"
          (onClick)="isOpenLotScanErrorModal = true"
        >
        </dx-button>
      </div>
    </dxi-item>
  </dxo-toolbar>

  <dxo-grouping [autoExpandAll]="expandAll"></dxo-grouping>
  <dxo-filter-row [visible]="true"></dxo-filter-row>
  <dxo-header-filter [visible]="true"></dxo-header-filter>

  <dxi-column
    dataField="model"
    caption="Model"
    [visible]="true"
    [groupIndex]="0"
  >
    <dxo-header-filter [allowSelectAll]="false">
      <dxo-search [enabled]="true"></dxo-search>
    </dxo-header-filter>
  </dxi-column>

  <dxi-column
    dataField="lotGroup"
    caption="Lot Group"
    [visible]="true"
    [groupIndex]="1"
  >
    <dxo-header-filter [allowSelectAll]="false">
      <dxo-search [enabled]="true"></dxo-search>
    </dxo-header-filter>
  </dxi-column>

  <dxi-column dataField="lotNo" caption="LotNo" [visible]="true"></dxi-column>

  <dxi-column
    dataField="qty"
    caption="Qty"
    [visible]="true"
    dataType="number"
    format="#,##0.0"
  ></dxi-column>

  <dxi-column
    dataField="statusName"
    caption="Status"
    [visible]="true"
    [cellTemplate]="statusCellTemplate"
  ></dxi-column>

  <dxo-summary>
    <dxi-group-item
      column="lotGroup"
      summaryType="count"
      displayFormat="{0} boxes"
    >
    </dxi-group-item>
    <dxi-group-item
      column="qty"
      summaryType="sum"
      [showInGroupFooter]="false"
      [alignByColumn]="true"
      displayFormat="Total Qty: {0}"
      valueFormat="#,##0.0"
    >
    </dxi-group-item>
  </dxo-summary>

  <dxo-paging [pageSize]="100"></dxo-paging>
  <dxo-pager
    [showPageSizeSelector]="true"
    [allowedPageSizes]="[10, 25, 50, 100]"
  >
  </dxo-pager>
</dx-data-grid>

<nz-modal
  [(nzVisible)]="isOpenReceiveModal"
  nzTitle="Nhận nguyên vật liệu"
  nzWidth="750px"
>
  <ng-container *nzModalContent>
    <nz-table [nzData]="['']" nzBordered nzFrontPagination="false">
      <thead>
        <tr>
          <th>
            <div nz-row nzJustify="start" nzAlign="middle" [nzGutter]="24">
              <div nz-col nzXs="4" nzSm="4" nzMd="4" nzLg="4">
                <dx-text-box
                  #userIdIpt
                  label="UserID"
                  labelLocation="left"
                  showColonAfterLabel="true"
                  [labelMode]="'static'"
                  (keydown.enter)="scanUserId($event)"
                  (click)="selectTextInput('userIdIpt')"
                ></dx-text-box>
              </div>
              <div nz-col nzXs="20" nzSm="20" nzMd="20" nzLg="20">
                <dx-text-box
                  #qrCodeIpt
                  label="QR Code"
                  labelLocation="left"
                  showColonAfterLabel="true"
                  [labelMode]="'static'"
                  (keydown.enter)="scanQRCode($event)"
                  (click)="selectTextInput('qrCodeIpt')"
                ></dx-text-box>
              </div>
            </div>
          </th>
        </tr>
      </thead>
    </nz-table>

    <nz-table
      #lotScanTbl
      [nzData]="litsLotScanOk"
      nzBordered
      nzSize="small"
      [nzFrontPagination]="true"
    >
      <thead>
        <tr>
          <th>Part No</th>
          <th>Lot No</th>
          <th>Qty</th>
          <th>Tồn</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of lotScanTbl.data">
          <td>{{ data.model }}</td>
          <td>{{ data.lotNo }}</td>
          <td class="editable-row" style="text-align: right">
            <div
              class="editable-cell"
              [hidden]="lotNoEdit === data.lotNo"
              (click)="startEdit(data)"
            >
              {{ data.qty | number : "1.0-3" }}
            </div>
            <input
              #qtyIpt
              [hidden]="lotNoEdit !== data.lotNo"
              type="number"
              nz-input
              [(ngModel)]="data.qty"
              (blur)="stopEdit(data)"
            />
          </td>
          <td>{{ data.remainQty | number : "1.0-3" }}</td>
          <td
              style="text-align: center"
              nz-popconfirm
              nzPopconfirmTitle="Có chắc chắn xóa không ?"
              nzPopconfirmPlacement="top"
              nzRight
            >
              <a style="color: red; font-weight: bold">Xóa</a>
            </td>
        </tr>
      </tbody>
    </nz-table>
  </ng-container>
  <div *nzModalFooter>
    <button nz-button nzType="default" (click)="isOpenReceiveModal = false">
      <span nz-icon nzType="close"></span>
      Đóng
    </button>
    <button
      nz-button
      nzType="primary"
      (click)="onReceiveMaterial()"
      [nzLoading]="isLoading"
    >
      <span nz-icon nzType="save"></span>
      Lưu
    </button>
  </div>
</nz-modal>

<nz-modal
  [(nzVisible)]="isOpenLotScanErrorModal"
  nzTitle="Thông tin lỗi khi scan nhận NVL"
  (nzOnCancel)="isOpenLotScanErrorModal = false"
  (nzOnOk)="isOpenLotScanErrorModal = false"
  nzWidth="100%"
>
  <div *nzModalContent>
    <dx-data-grid
      #lotScanErrorGrid
      keyExpr="lotNo"
      [dataSource]="lotScanErrors"
      [showColumnLines]="true"
      [showRowLines]="true"
      [showBorders]="true"
      [allowColumnResizing]="true"
      [columnAutoWidth]="true"
      [rowAlternationEnabled]="true"
    >
      <dxi-column
        dataField="model"
        caption="Model"
        [visible]="true"
      ></dxi-column>
      <dxi-column
        dataField="lotNo"
        caption="LotNo"
        [visible]="true"
      ></dxi-column>
      <dxi-column
        dataField="errorInfo"
        caption="Thông tin lỗi"
        [visible]="true"
      ></dxi-column>
    </dx-data-grid>
  </div>
</nz-modal>
